<!DOCTYPE html PUBLIC "-/>
<html lang="en">
<head>
<title>NullMQ placement server example</title>
<link href="/dist/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<link href="/dist/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
<link href="/dist/lib/jquery-ui.css" rel="stylesheet">
<script type="text/javascript" src="/dist/lib/jquery-latest.js"></script>
<script type="text/javascript" src="/dist/lib/jquery-ui.js"></script>
<script type="text/javascript" src="/dist/lib/coffee-script.js"></script>
<script type="text/javascript" src="/dist/lib/d3.v2.js"></script>
<script type="text/javascript" src="/dist/lib/underscore-min.js"></script>
<script type="text/javascript" src="/dist/lib/mousetrap.min.js"></script>
<script type="text/javascript" src="/dist/lib/stomp.js"></script>
<script type="text/javascript" src="/dist/lib/nullmq.js"></script>
<script type="text/javascript" src="/dist/lib/sylvester.js"></script>
<script type="text/javascript" src="/dist/lib/glUtils.js"></script>
<script type="text/javascript" src="/dist/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/dist/bootstrap/js/bootstrapx-clickover.js"></script>
<script type="text/javascript" src="/dist/lib/bootstrap-contextmenu.js"></script>
<style  type="text/css">
.improving {
    background-color: #D5ECBF !important;
    border-color: #D2E6AB !important;
    color: #669533 !important;
}
.non_improving {
    background-color: #F2BDB1 !important;
    border-color: #F0A5A4 !important;
    color: #BD4247 !important;
}
</style>
</head>
<body>
<div class="container">

<section id="placement_server_example">
  <div class="page-header">
    <h1>NullMQ placement server example</h1>
  </div>
  <div class="row">
    <p class="lead">Click the button below to load block positions from placement controller.</p>
    <fieldset>
        <label>NullMQ-to-ZeroMQ bridge URI</label>
        <select id="id_nullmq_zmq_bridge">
          <option value="ws://localhost:9000" default>localhost:9000</option>
          <option value="ws://maeby.fobel.net:9000">maeby.fobel.net:9000</option>
        </select>
        <label>Select architecture:</label>
        <select id="id_architecture_chooser"></select>
        <label>Select netlist:</label>
        <select id="id_netlist_chooser"></select>
        <label>Select modifier type:</label>
        <select id="id_modifier_chooser"></select>
        <!--<button name="load_placement" id="id_load_placement">Load placement</button>-->
        <button name="make_controller" id="id_make_controller">Make controller</button>
        <button name="reset" id="id_reset">Reset</button>
        <button name="foo" id="id_foo">Foo</button>
    </fieldset>
  </div>
</section>

<section id="controllers">
 <div class="row">
  <table class="table">
   <tbody id="id_controllers_tbody">
    <tr>
     <th id="id_controller_id_header">id</th>
     <th id="id_modifier_class">modifier</th>
     <th id="id_netlist_header">net</th>
     <!--<th id="id_arch_header">arch</th>-->
     <th id="id_iteration_header">iteration</th>
     <th id="id_rep_uri_header">rep</th>
     <th id="id_pub_uri_header">pub</th>
     <th id="id_actions_header">actions</th>
    </tr>
   </tbody>
 </table>
 </div>
</section>
<section class="template">
 <table class="invisible" >
 <!-- The contents of the tag are used as a template to format an info table
   for a block -->
     <tbody><tr id="id_controller_row_template">
       <th class="controller_id" title="{{ process_id }}">{{ process_id_short }}</th>
       <td class="modifier_class">{{ controller.config.modifier_class }}</td>
       <td class="netlist" title="{{ controller.config.netlist_path }}">{{ netlist_path_short }}</td>
       <!--<td class="arch" title="{{ controller.config.arch_path }}">{{ arch_path_short }}</td>-->
       <td class="iteration"></td>
       <td class="rep_uri">{{ controller.rep_uri }}</td>
       <td class="pub_uri">{{ controller.pub_uri }}</td>
       <td class="actions">
          <div class="action_iterate">
            <button class="btn btn-mini">iterate</button>
          </div>
       </td>
     </tr></tbody>
 </table>
</section>

<script type="text/coffeescript" src="/dist/lib/mixin.coffee"></script>
<script type="text/coffeescript" src="/dist/echo_controller.coffee"></script>
<script type="text/coffeescript" src="/dist/controller_factory_proxy.coffee"></script>
<script type="text/coffeescript" src="/dist/coffee_helpers.coffee"></script>
<script type="text/coffeescript">

    @netlist_chooser = $('#id_netlist_chooser')
    @architecture_chooser = $('#id_architecture_chooser')
    @modifier_chooser = $('#id_modifier_chooser')
    @bridge_uri = $('#id_nullmq_zmq_bridge option:selected').val()
    @context = new nullmq.Context(@bridge_uri)

    @controller_factory = new ControllerFactoryProxy(@context, 'tcp://localhost:55555')

    $(this.controller_factory).on("reset_completed", (e) => 
        coffee_helpers.set_paths(@controller_factory.netlists, @netlist_chooser)
        coffee_helpers.set_paths(@controller_factory.architectures, @architecture_chooser)
        coffee_helpers.set_options(@controller_factory.modifier_names, @modifier_chooser)
    )

    class ControllerProxy extends EchoJsonController
        constructor: (@context, @rep_uri, @pub_uri, @config) ->
            super @context, @rep_uri
            @socks =
                rep: @echo_fe
                sub: @context.socket(nullmq.SUB)
            @socks.sub.connect(@pub_uri)
            @socks.sub.setsockopt(nullmq.SUBSCRIBE, "")
            @socks.sub.recvall(@process_status_update)
            obj = @
            $(obj).on("async_response", (e) =>
                @process_async_response(e.response)
            )
            $(obj).on("iteration_completed", (e) =>
                console.log("iteration_completed", e)
                @row().find('td.iteration').html(e.outer_i + ", " + e.inner_i)
            )

            @pending_requests = {}
            @pending_iterations = {}

        row: () => 
            $('#id_controllers_tbody > tr.controller_row[data-id="' + @config.process_id + '"]')

        process_async_response: (message) =>
            obj = @
            if 'command' of message and message.command == 'iter__next'
                data =
                    type: "iteration_completed"
                    response: message
                    outer_i: message.outer_i
                    inner_i: message.inner_i
                    next_outer_i: message.result[0]
                    next_inner_i: message.result[1]
                $(obj).trigger(data)

        process_status_update: (message) =>
            obj = @
            message = @deserialize(message)
            if 'async_id' of message
                if message.async_id of @pending_requests
                    $(obj).trigger(type: "async_response", controller: obj, response: message)
                    delete @pending_requests[message.async_id]
                if message.async_id of @pending_iterations
                    delete @pending_iterations[message.async_id]

        do_request: (message, on_recv) =>
            _on_recv = (message) =>
                on_recv(message)
                if 'async_id' of message
                    @pending_requests[message.async_id] = message
                    if 'command' of message and message.command == 'iter__next'
                        @pending_iterations[message.async_id] = message
            super message, _on_recv


    class ControllerProxyManager
        constructor: () ->
            @controllers = {}

        add: (process_id, controller) =>
            @controllers[process_id] = controller

        controller_list: () => (process_id: k, controller: v for k,v of @controllers)


    @controller_manager = new ControllerProxyManager()
    $(this.controller_factory).on("controller", (e) => 
        console.log("controller created", e)
        controller = new ControllerProxy(@context, e.uris.rep, e.uris.pub, e)
        @controller_manager.add(e.process_id, controller)
    )

    $("#id_foo").click(() =>
        _.templateSettings =
          interpolate: /\{\{(.+?)\}\}/g

        template_text = d3.select("#id_controller_row_template").html()
        template = _.template(template_text)

        controllers = @controller_manager.controller_list()
        console.log(controllers)
        rows = d3.select('#id_controllers_tbody').selectAll('.controller_row')
          .data(controllers, (d) -> d.process_id)
        rows.exit().remove()
        rows.enter()
          .append("tr")
            .attr("class", "controller_row")
            .attr("data-id", (d) -> d.process_id)
            .html((d) ->
                h_ = coffee_helpers
                data =
                    process_id_short: h_.split_last(d.process_id, ' ')[0..7]
                    netlist_path_short: h_.split_last(d.controller.config.netlist_path, '/')
                    arch_path_short: h_.split_last(d.controller.config.arch_path, '/')
                data = $().extend(d, data)
                console.log("data", data)
                template(data)
            )
            .each((d) ->
                c = d.controller
                c.do_request({"command": "initialize", "kwargs": {"depth": 2}}, (value) =>
                    c.do_request({"command": "iter__next"}, (value) =>
                        c.do_request({"command": "iter__next"}, (value) =>
                            c.row().find('.action_iterate > button').click(() ->
                                d.controller.do_request({"command": "iter__next"}, () -> null)
                            )
                        )
                    )
                )
            )
    )

    $("#id_make_controller").click(() =>
        netlist = @netlist_chooser.val()
        arch = @architecture_chooser.val()
        modifier_class = @modifier_chooser.val()
        @controller_factory.make_controller(netlist, arch, modifier_class)
    )
    $("#id_reset").click(() => @controller_factory.reset())

    @controller_factory.reset()
</script>
</body>
</html>
