<!DOCTYPE html PUBLIC "-/>
<html lang="en">
<head>
<title>NullMQ placement server example</title>
<link href="/dist/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<link href="/dist/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
<link href="/dist/lib/jquery-ui.css" rel="stylesheet">
<script type="text/javascript" src="/dist/lib/jquery-latest.js"></script>
<script type="text/javascript" src="/dist/lib/jquery-ui.js"></script>
<script type="text/javascript" src="/dist/lib/coffee-script.js"></script>
<script type="text/javascript" src="/dist/lib/d3.v2.js"></script>
<script type="text/javascript" src="/dist/lib/underscore-min.js"></script>
<script type="text/javascript" src="/dist/lib/mousetrap.min.js"></script>
<script type="text/javascript" src="/dist/lib/stomp.js"></script>
<script type="text/javascript" src="/dist/lib/nullmq.js"></script>
<script type="text/javascript" src="/dist/lib/sylvester.js"></script>
<script type="text/javascript" src="/dist/lib/glUtils.js"></script>
<script type="text/javascript" src="/dist/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/dist/bootstrap/js/bootstrapx-clickover.js"></script>
<script type="text/javascript" src="/dist/lib/bootstrap-contextmenu.js"></script>
<style  type="text/css">
.improving {
    background-color: #D5ECBF !important;
    border-color: #D2E6AB !important;
    color: #669533 !important;
}
.non_improving {
    background-color: #F2BDB1 !important;
    border-color: #F0A5A4 !important;
    color: #BD4247 !important;
}

#id_controllers_tbody  {
    font-size: 0.9em;
}
</style>
</head>
<body>
<div class="container">

<section id="placement_server_example">
  <div class="page-header">
    <h1>NullMQ placement server example</h1>
  </div>
  <div class="row">
    <p class="lead">Click the button below to load block positions from placement controller.</p>
    <fieldset>
        <label>NullMQ-to-ZeroMQ bridge URI</label>
        <select id="id_nullmq_zmq_bridge">
          <option value="ws://localhost:9000" default>localhost:9000</option>
          <option value="ws://maeby.fobel.net:9000">maeby.fobel.net:9000</option>
        </select>
        <label>Select architecture:</label>
        <select id="id_architecture_chooser"></select>
        <label>Select netlist:</label>
        <select id="id_netlist_chooser"></select>
        <label>Select modifier type:</label>
        <select id="id_modifier_chooser"></select>
        <!--<button name="load_placement" id="id_load_placement">Load placement</button>-->
        <button name="make_controller" id="id_make_controller">Make controller</button>
        <button name="reset" id="id_reset">Reset</button>
        <button name="foo" id="id_foo">Foo</button>
    </fieldset>
  </div>
</section>

<section id="controllers">
 <div class="row">
  <table class="table table-striped">
   <tbody id="id_controllers_tbody">
    <tr>
     <th id="id_controller_id_header">id</th>
     <th id="id_modifier_class">modifier</th>
     <th id="id_netlist_header">net</th>
     <!--<th id="id_arch_header">arch</th>-->
     <th id="id_iteration_header">iteration</th>
     <th id="id_rep_uri_header">rep</th>
     <th id="id_pub_uri_header">pub</th>
     <th id="id_actions_header">actions</th>
    </tr>
   </tbody>
 </table>
 </div>
</section>
<section class="template">
 <table class="invisible" >
 <!-- The contents of the tag are used as a template to format an info table
   for a block -->
     <tbody><tr id="id_controller_row_template">
       <th class="controller_id" title="{{ process_id }}">{{ process_id_short }}</th>
       <td class="modifier_class">{{ controller.config.modifier_class }}</td>
       <td class="netlist" title="{{ controller.config.netlist_path }}">{{ netlist_path_short }}</td>
       <!--<td class="arch" title="{{ controller.config.arch_path }}">{{ arch_path_short }}</td>-->
       <td class="iteration"></td>
       <td class="rep_uri">{{ controller.rep_uri }}</td>
       <td class="pub_uri">{{ controller.pub_uri }}</td>
       <td class="actions">
          <div class="action_iterate">
            <button class="btn btn-mini">iterate</button>
          </div>
          <div class="action_kill">
            <button class="btn btn-mini btn-danger">kill</button>
          </div>
       </td>
     </tr></tbody>
 </table>
</section>

<script type="text/coffeescript" src="/dist/lib/mixin.coffee"></script>
<script type="text/coffeescript" src="/dist/echo_controller.coffee"></script>
<script type="text/coffeescript" src="/dist/controller_factory_proxy.coffee"></script>
<script type="text/coffeescript" src="/dist/coffee_helpers.coffee"></script>
<script type="text/coffeescript">

    @netlist_chooser = $('#id_netlist_chooser')
    @architecture_chooser = $('#id_architecture_chooser')
    @modifier_chooser = $('#id_modifier_chooser')
    @bridge_uri = $('#id_nullmq_zmq_bridge option:selected').val()
    @context = new nullmq.Context(@bridge_uri)

    @controller_factory = new ControllerFactoryProxy(@context, 'tcp://localhost:44444')

    class ControllerProxy extends EchoJsonController
        constructor: (@context, @rep_uri, @pub_uri, @config) ->
            super @context, @rep_uri
            @socks =
                rep: @echo_fe
                sub: @context.socket(nullmq.SUB)
            @socks.sub.connect(@pub_uri)
            @socks.sub.setsockopt(nullmq.SUBSCRIBE, "")
            @socks.sub.recvall(@process_status_update)
            @pending_requests = {}
            @pending_iterations = {}
            @pending_config = {}
            @pending_outer_i = {}
            @pending_inner_i = {}
            @outer_i = null
            @inner_i = null
            @_initialized = false
            @_initializing = false

            obj = @

            $(obj).on("async_response", (e) =>
                @process_async_response(e.response)
            )
            $(obj).on("iteration_completed", (e) =>
                obj.set_iteration_indexes(e.outer_i, e.inner_i)
                obj.update_iteration_count()
            )
            $(obj).on("iteration_update", (e) =>
                #console.log("iteration_update", e, e.response.outer_i, e.response.inner_i)
                obj.set_iteration_indexes(e.response.outer_i, e.response.inner_i)
                obj.update_iteration_count()
            )
            $(obj).on("config_updated", (e) =>
                if 'netlist_file' of e.config
                    @config.netlist_path = e.config.netlist_file
                if 'arch_file' of e.config
                    @config.arch_path = e.config.arch_file
                obj.update_config()
            )

            @do_request({"command": "config_dict"}, (value) =>
                # This will force initialization, if necessary
                @sync_iteration_indexes()
            )

        set_iteration_indexes: (outer_i, inner_i) =>
            if outer_i != null and not @_initialized
                console.log("initialized", @config.process_id)
                @_initialized = true
            @outer_i = outer_i
            @inner_i = inner_i

        sync_iteration_indexes: () =>
            obj = @
            obj.do_request({"command": "iter__outer_i"}, (value) =>
                obj.do_request({"command": "iter__inner_i"}, (value) =>)
            )

        initialize: (force=false) =>
            obj = @
            if force or not @_initialized and not @_initializing
                @_initializing = true
                #console.log("initialize")
                obj.do_request({"command": "initialize", "kwargs": {"depth": 2}}, (value) =>
                    obj.do_request({"command": "iter__next"}, (value) =>
                        obj.do_request({"command": "iter__next"}, (value) =>
                            @_initializing = false
                        )
                    )
                )

        update_config: () =>
            @row().find('td.netlist')
                .html(coffee_helpers.split_last(@config.netlist_path, '/'))
                .attr("title", @config.netlist_path)

        update_iteration_count: () =>
            remaining = Object.keys(@pending_iterations).length
            if remaining > 0
                remaining_text = " (" + remaining + ")"
            else
                remaining_text = ""
            class_ = "iteration" + (if remaining then " alert alert-info" else "")
            @row().find('td.iteration')
                .attr("class", class_)
                .html(
                    if @outer_i? and @inner_i?
                        @outer_i + ", " + @inner_i + remaining_text
                    else
                        "initializing..." + remaining_text
                )

        row: () => 
            $('#id_controllers_tbody > tr.controller_row[data-id="' + @config.process_id + '"]')

        process_async_response: (message) =>
            obj = @
            ###
            if not ('command' of message) or message.command != 'swap_info'
                console.log("process_async_response", message)
            ###
            if 'command' of message and message.command == 'iter__next'
                data =
                    type: "iteration_completed"
                    response: message
                    outer_i: message.outer_i
                    inner_i: message.inner_i
                    next_outer_i: message.result[0]
                    next_inner_i: message.result[1]
                $(obj).trigger(data)
            if 'command' of message and message.command in ['iter__outer_i', 'iter__inner_i']
                #console.log("process_async_response->outer/inner_i", message, ('error' of message))
                if ('error' of message) or message.outer_i == null
                    @initialize()
                else
                    data =
                        type: "iteration_update"
                        response: message
                        outer_i: message.outer_i
                        inner_i: message.inner_i
                    $(obj).trigger(data)
            else if 'command' of message and message.command == 'config_dict'
                data =
                    type: "config_updated"
                    response: message
                    config: message.result
                $(obj).trigger(data)

        process_status_update: (message) =>
            obj = @
            message = @deserialize(message)
            if 'async_id' of message
                if message.async_id of @pending_config
                    delete @pending_config[message.async_id]
                    # Manually override `command` field, since
                    # `process_async_response` depends on it
                    message.command = 'config_dict'
                if message.async_id of @pending_outer_i
                    delete @pending_outer_i[message.async_id]
                    message.command = 'iter__outer_i'
                if message.async_id of @pending_inner_i
                    delete @pending_inner_i[message.async_id]
                    message.command = 'iter__inner_i'
                if message.async_id of @pending_iterations
                    delete @pending_iterations[message.async_id]
                if message.async_id of @pending_requests
                    delete @pending_requests[message.async_id]
                    $(obj).trigger(type: "async_response", controller: obj, response: message)
                if message.async_id of @pending_outer_i
                    delete @pending_outer_i[message.async_id]

        do_request: (message, on_recv) =>
            _on_recv = (message) =>
                if 'async_id' of message
                    @pending_requests[message.async_id] = message
                    if 'command' of message and message.command == 'iter__next'
                        @pending_iterations[message.async_id] = message
                    if 'command' of message and message.command == 'config_dict'
                        @pending_config[message.async_id] = message
                    if message.command? and message.command == 'outer_i'
                        @pending_outer_i[message.async_id] = message
                    if message.command? and message.command == 'inner_i'
                        @pending_inner_i[message.async_id] = message
                on_recv(message)
            super message, _on_recv

    @ControllerProxy = ControllerProxy


    class ControllerProxyManager
        constructor: () ->
            @controllers = {}

        add: (process_id, controller) =>
            @controllers[process_id] = controller
            obj = @
            $(obj).trigger(type: "controller_added", process_id: process_id, controller: controller)

        remove: (process_id) =>
            delete @controllers[process_id]
            obj = @
            $(obj).trigger(type: "controller_removed", process_id: process_id)

        controller_list: () => (process_id: k, controller: v for k,v of @controllers)


    @controller_manager = new ControllerProxyManager()

    update_controller_table = () =>
        _.templateSettings =
          interpolate: /\{\{(.+?)\}\}/g

        template_text = d3.select("#id_controller_row_template").html()
        template = _.template(template_text)

        obj = @

        controllers = obj.controller_manager.controller_list()
        rows = d3.select('#id_controllers_tbody').selectAll('.controller_row')
          .data(controllers, (d) -> d.process_id)
        rows.exit().remove()
        rows.enter()
          .append("tr")
            .attr("class", "controller_row")
            .attr("data-id", (d) -> d.process_id)
            .html((d) ->
                h_ = coffee_helpers
                netlist_path = d.controller.config.netlist_path ? '(pending...)'
                arch_path = d.controller.config.arch_path ? '(pending...)'
                data =
                    process_id_short: h_.split_last(d.process_id, ' ')[0..7]
                    netlist_path_short: h_.split_last(netlist_path, '/')
                    arch_path_short: h_.split_last(arch_path, '/')
                data = $().extend(d, data)
                template(data)
            )
            .each((d) ->
                c = d.controller
                c.row().find('.action_iterate > button').click(() ->
                    c.do_request({"command": "iter__next"}, () ->
                        c.update_iteration_count()
                    )
                )
                c.row().find('.action_kill > button').click(() ->
                    terminate_data =
                        command: 'terminate_process'
                        kwargs:
                            process_id: d.process_id
                    obj.controller_factory.do_request(terminate_data, (value) =>
                        #console.log("process_terminated", value)
                        if not ('error' of value)
                            obj.controller_manager.remove(d.process_id)
                    )
                )
            )

    $(this.controller_factory).on("controller", (e) => 
        if not (e.process_id of @controller_manager.controllers)
            controller = new ControllerProxy(@context, e.uris.rep, e.uris.pub, e)
            @controller_manager.add(e.process_id, controller)
        else
            console.log("on controller", "ignoring existing controller:", e.process_id)
    )

    $(this.controller_manager).on("controller_added", (e) => 
        update_controller_table()
    )

    $(this.controller_manager).on("controller_removed", (e) => 
        update_controller_table()
    )

    $("#id_make_controller").click(() =>
        netlist = @netlist_chooser.val()
        arch = @architecture_chooser.val()
        modifier_class = @modifier_chooser.val()
        @controller_factory.make_controller(netlist, arch, modifier_class)
    )

    $(this.controller_factory).on("reset_completed", (e) => 
        coffee_helpers.set_paths(@controller_factory.netlists, @netlist_chooser)
        coffee_helpers.set_paths(@controller_factory.architectures, @architecture_chooser)
        coffee_helpers.set_options(@controller_factory.modifier_names, @modifier_chooser)
    )

    $("#id_reset").click(() => @controller_factory.reset())

    @controller_factory.reset()
</script>
</body>
</html>
