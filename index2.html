<!DOCTYPE html PUBLIC "-/>
<html lang="en">
<head>
<title>NullMQ placement server example</title> <link href="/dist/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<link href="/dist/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
<link href="/dist/lib/jquery-ui.css" rel="stylesheet">
<script type="text/javascript" src="/dist/lib/jquery-latest.js"></script>
<script type="text/javascript" src="/dist/lib/jquery-ui.js"></script>
<script type="text/javascript" src="/dist/lib/coffee-script.js"></script>
<script type="text/javascript" src="/dist/lib/d3.v2.js"></script>
<script type="text/javascript" src="/dist/lib/underscore-min.js"></script>
<script type="text/javascript" src="/dist/lib/mousetrap.min.js"></script>
<script type="text/javascript" src="/dist/lib/stomp.js"></script>
<script type="text/javascript" src="/dist/lib/nullmq.js"></script>
<script type="text/javascript" src="/dist/lib/sylvester.js"></script>
<script type="text/javascript" src="/dist/lib/glUtils.js"></script>
<script type="text/javascript" src="/dist/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/dist/bootstrap/js/bootstrapx-clickover.js"></script>
<script type="text/javascript" src="/dist/lib/bootstrap-contextmenu.js"></script>
<style  type="text/css">
.improving {
    background-color: #D5ECBF !important;
    border-color: #D2E6AB !important;
    color: #669533 !important;
}
.non_improving {
    background-color: #F2BDB1 !important;
    border-color: #F0A5A4 !important;
    color: #BD4247 !important;
}

.actions div {
    float: left;
}

#id_controllers_tbody  {
    font-size: 0.9em;
}
</style>
</head>
<body>
<div class="container-fluid">

<section class="settings">
  <div class="row-fluid">
    <div class="form-inline">
    <fieldset>
        <label>NullMQ-to-ZeroMQ bridge URI</label>
        <select id="id_nullmq_zmq_bridge">
          <option value="ws://localhost:9000" default>localhost:9000</option>
          <option value="ws://maeby.fobel.net:9000">maeby.fobel.net:9000</option>
        </select>
        <label>Select architecture:</label>
        <select id="id_architecture_chooser"></select>
        <label>Select netlist:</label>
        <select id="id_netlist_chooser"></select>
        <label>Select modifier type:</label>
        <select id="id_modifier_chooser"></select>
        <label>Seed:</label>
        <input id="id_seed" type="text" maxlength="4" style="width: 40px;" value="1">
        <!--<button name="load_placement" id="id_load_placement">Load placement</button>-->
        <button name="make_controller" id="id_make_controller">Make controller</button>
        <button name="reset" id="id_reset">Reset</button>
    </fieldset>
    </div>
  </div>
</section>

<section class="controllers">
 <div class="row-fluid">
  <table class="table table-striped">
   <tbody id="id_controllers_tbody">
    <tr>
     <th id="id_select">&nbsp;</th>
     <th id="id_controller_id_header">id</th>
     <th id="id_modifier_class">modifier</th>
     <th id="id_seed">seed</th>
     <th id="id_netlist_header">net</th>
     <!--<th id="id_arch_header">arch</th>-->
     <th id="id_iteration_header">iteration</th>
     <th id="id_rep_uri_header">rep</th>
     <th id="id_pub_uri_header">pub</th>
     <th id="id_actions_header">actions</th>
    </tr>
   </tbody>
 </table>
 </div>
</section>
<section class="placements">
 <div class="row-fluid">
<div id="id_placement_a" class="span5"></div>
<div class="span2"></div>
<div id="id_placement_b" class="span5"></div>
</div>
</section>
<section class="template">
 <table class="invisible" >
 <!-- The contents of the tag are used as a template to format an info table
   for a block -->
     <tbody><tr id="id_controller_row_template">
       <th class="select" title="select"><input type="checkbox" data-id="{{ process_id }}"></th>
       <th class="controller_id" title="{{ process_id }}">{{ process_id_short }}</th>
       <td class="modifier_class">{{ controller.config.modifier_class }}</td>
       <td class="seed">{{ seed }}</td>
       <td class="netlist" title="{{ controller.config.netlist_path }}">{{ netlist_path_short }}</td>
       <!--<td class="arch" title="{{ controller.config.arch_path }}">{{ arch_path_short }}</td>-->
       <td class="iteration"></td>
       <td class="rep_uri">{{ controller.rep_uri }}</td>
       <td class="pub_uri">{{ controller.pub_uri }}</td>
       <td class="actions">
          <div class="action_iterate">
            <button class="btn btn-mini">iterate</button>
          </div>
          <div class="action_kill">
            <button class="btn btn-mini btn-danger">kill</button>
          </div>
          <div class="action_placement_a">
            <button class="btn btn-mini btn-info">a</button>
          </div>
          <div class="action_placement_b">
            <button class="btn btn-mini btn-success">b</button>
          </div>
       </td>
     </tr></tbody>
 </table>
 <div class="invisible" >
 <!-- The contents of the tag are used as a template to format an info table
   for a block -->
    <div class="grid_header_template">
        <table>
            <tbody>
            <tr>
                <td>
                    {{ block.id }}
                </td>
                <td>
                    ({{ position.x }}, {{ position.y }})
                </td>
            </tr>
            </tbody>
        </table>
    </div>
 </div>
</section>

<!--<script type="text/javascript" src="/dist/test.js"></script>-->
<script type="text/coffeescript" src="/dist/lib/mixin.coffee"></script>
<script type="text/coffeescript" src="/dist/echo_controller.coffee"></script>
<script type="text/coffeescript" src="/dist/place_context.coffee"></script>
<script type="text/coffeescript" src="/dist/controller_factory_proxy.coffee"></script>
<script type="text/coffeescript" src="/dist/controller_proxy.coffee"></script>
<script type="text/coffeescript" src="/dist/controller_proxy_manager.coffee"></script>
<script type="text/coffeescript" src="/dist/placement_collector.coffee"></script>
<script type="text/coffeescript" src="/dist/placement_comparator.coffee"></script>
<script type="text/coffeescript" src="/dist/grid.coffee"></script>
<script type="text/coffeescript" src="/dist/coffee_helpers.coffee"></script>
<script type="text/coffeescript">

    @netlist_chooser = $('#id_netlist_chooser')
    @architecture_chooser = $('#id_architecture_chooser')
    @modifier_chooser = $('#id_modifier_chooser')
    @seed_input = $('#id_seed')
    @bridge_uri = $('#id_nullmq_zmq_bridge option:selected').val()
    @zmq_context = new nullmq.Context(@bridge_uri)

    @controller_factory = new ControllerFactoryProxy(@zmq_context, 'tcp://localhost:33333')
    @controller_manager = new ControllerProxyManager()

    @placement_comparator = new PlacementComparator(d3.select("#id_placement_a"), d3.select("#id_placement_b"))

    update_controller_table = () =>
        _.templateSettings =
          interpolate: /\{\{(.+?)\}\}/g

        template_text = d3.select("#id_controller_row_template").html()
        template = _.template(template_text)

        obj = @

        controllers = obj.controller_manager.controller_list()
        rows = d3.select('#id_controllers_tbody').selectAll('.controller_row')
          .data(controllers, (d) -> d.process_id)
        rows.exit().remove()
        rows.enter()
          .append("tr")
            .attr("class", "controller_row")
            .attr("data-id", (d) -> d.process_id)
            .html((d) ->
                h_ = coffee_helpers
                netlist_path = d.controller.config.netlist_path ? '(pending...)'
                arch_path = d.controller.config.arch_path ? '(pending...)'
                data =
                    process_id_short: h_.split_last(d.process_id, ' ')[0..7]
                    netlist_path_short: h_.split_last(netlist_path, '/')
                    arch_path_short: h_.split_last(arch_path, '/')
                    seed: if d.controller.config.placer_opts? then d.controller.config.placer_opts.seed else '-'
                data = $().extend(d, data)
                template(data)
            )
            .each((d) ->
                c = d.controller
                c.row().find('.action_iterate > button').click(() ->
                    c.do_iteration()
                )
                c.row().find('.action_kill > button').click(() ->
                    obj.controller_factory.terminate(d.process_id, (value) =>
                        if not ('error' of value)
                            obj.controller_manager.remove(d.process_id)
                    )
                )
                c.row().find('.action_placement_a > button').click(() ->
                    p = new PlacementCollector([d])
                    p.collect('get_block_positions', (placements) ->
                        placement_comparator.grid_a.set_raw_block_positions(placements[0].result)
                    )
                )
                c.row().find('.action_placement_b > button').click(() ->
                    p = new PlacementCollector([d])
                    p.collect('get_block_positions', (placements) ->
                        placement_comparator.grid_b.set_raw_block_positions(placements[0].result)
                    )
                )
            )


    @selected_process_ids = () =>
        d.dataset.id for d in $("#id_controllers_tbody input[type='checkbox']:checked")

    @all_process_ids = () =>
        d.dataset.id for d in $("#id_controllers_tbody input[type='checkbox']")

    @selected_process_infos = () =>
        {process_id: id, controller: @controller_manager.controllers[id]} for id in @selected_process_ids()

    @all_process_infos = () =>
        {process_id: id, controller: @controller_manager.controllers[id]} for id in @all_process_ids()

    @apply_to_selected_placements = (on_recv) =>
        p = new PlacementCollector(@selected_process_infos())
        p.collect('get_block_positions', on_recv)

    $(this.controller_factory).on("controller", (e) => 
        if not (e.process_id of @controller_manager.controllers)
            controller = new ControllerProxy(@zmq_context, e.uris.rep, e.uris.pub, e)
            @controller_manager.add(e.process_id, controller)
        else
            console.log("on controller", "ignoring existing controller:", e.process_id)
    )

    $(this.controller_manager).on("controller_added", (e) => 
        update_controller_table()
    )

    $(this.controller_manager).on("controller_removed", (e) => 
        update_controller_table()
    )

    $("#id_make_controller").click((e) =>
        netlist = @netlist_chooser.val()
        arch = @architecture_chooser.val()
        modifier_class = @modifier_chooser.val()
        modifier_class = @modifier_chooser.val()
        seed = +@seed_input.val()
        @controller_factory.make_controller(netlist, arch, modifier_class, seed)
        e.preventDefault()
    )

    $(this.controller_factory).on("reset_completed", (e) => 
        coffee_helpers.set_paths(@controller_factory.netlists, @netlist_chooser)
        coffee_helpers.set_paths(@controller_factory.architectures, @architecture_chooser)
        coffee_helpers.set_options(@controller_factory.modifier_names, @modifier_chooser)
    )

    $("#id_reset").click(() => @controller_factory.reset())

    @controller_factory.reset()
</script>
</body>
</html>
