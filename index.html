<!DOCTYPE html PUBLIC "-/>
<html lang="en">
<head>
<title>NullMQ placement server example</title>
<link href="/dist/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<link href="/dist/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
<link href="/dist/lib/jquery-ui.css" rel="stylesheet">
<script type="text/javascript" src="/dist/lib/jquery-latest.js"></script>
<script type="text/javascript" src="/dist/lib/jquery-ui.js"></script>
<script type="text/javascript" src="/dist/lib/coffee-script.js"></script>
<script type="text/javascript" src="/dist/lib/d3.v2.js"></script>
<script type="text/javascript" src="/dist/lib/underscore-min.js"></script>
<script type="text/javascript" src="/dist/lib/mousetrap.min.js"></script>
<script type="text/javascript" src="/dist/lib/stomp.js"></script>
<script type="text/javascript" src="/dist/lib/nullmq.js"></script>
<script type="text/javascript" src="/dist/bootstrap/js/bootstrap.min.js"></script>
</head>
<body>
<div class="container">

<section id="placement_server_example">
  <div class="page-header">
    <h1>NullMQ placement server example</h1>
  </div>
  <div class="row">
    <p class="lead">Click the button below to load block positions from placement controller.</p>
    <fieldset>
        <button name="load_placement" id="id_load_placement">Load placement</button>
    </fieldset>
  </div>
</section>

<section id="placement">
  <div class="row">
    <div id="chart" class="span8 visible"></div>
    <div class="span4">
      <div class="row">
        <h4>Swap context:</h4>
        <div id="id_swap_context_current"></div>
        <div class="span4 visible" style="height: 500; overflow: auto">
          <table class="table-condensed table-bordered table-striped">
            <tbody id="swap_context_list" style="font-size: 80%;">
                <th>i</th>
                <th>+</th>
                <th>-</th>
                <th>Total</th>
                <th>Goto</th>
                <th>&nbsp;</th>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="span4">
      <div class="row">
        <h3>Current block:</h3>
        <div id="placement_info_current" class="span4 visible" ></div>
      </div>
    </div>
    <div class="span4">
      <div class="row">
        <h3>Selected blocks:</h3>
        <fieldset>
            <button name="clear_selection" id="id_clear_selection">Clear selection</button>
        </fieldset>
        <div id="placement_info_selected" class="span4 visible" ></div>
      </div>
    </div>
    <div id="placement_info_template" class="invisible" >
    <!-- The contents of the tag are used as a template to format an info table
        for a block -->
        <table class="condensed-table table-bordered table-striped table-hover">
            <tbody>
            <tr><th>Coordinates</th><td class="block_coordinates">({{ x }}, {{ y }})</td></tr>
            <tr><th>Block id</th><td class="block_id">{{ block_id }}</td></tr>
            </tbody>
        </table>
    </div>
    <table class="invisible" >
    <!-- The contents of the tag are used as a template to format an info table
      for a block -->
        <tbody><tr id="swap_context_template">
          <th id="id_swap_context_row_index_{{ index }}" class="swap_context_row_index" style="text-align: center">{{ index }}</th>
          <td id="id_swap_context_row_accepted_{{ index }}" class="swap_context_row_accepted" style="text-align: center">{{ accepted_count }}</td>
          <td id="id_swap_context_row_skipped_{{ index }}" class="swap_context_row_skipped" style="text-align: center">{{ skipped_count }}</td>
          <td id="id_swap_context_row_total_{{ index }}" class="swap_context_row_total" style="text-align: center">{{ participated_count }}/{{ total_count }}</td>
          <td>
            <a href="#" class="btn btn-mini" id="id_swap_context_select_{{ index }}">select</a>
          </td>
          <td>
            <a href="#myModal_{{ index }}" role="button" class="btn btn-mini" data-toggle="modal">details</a>
          </td>
        </tr></tbody>
    </table>

    <div id="swap_context_detail_template" class="invisible" >
      <div id="myModal_{{ index }}" data-backdrop="false" class="span4 modal hide" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <strong>Swap context {{ index }}</strong>
      </div>
      <div id="swap_context_{{ index }}" class="modal-body">
        <table class="table-condensed table-bordered table-striped table-hover">
          <tbody id="id_swap_context_tbody_{{ index }}"></tbody>
        </table>
      </div>
      </div>
    </div>



    </div>
  </div>
</section>

<script type="text/coffeescript" src="/dist/grid.coffee"></script>
<script type="text/coffeescript" src="/dist/echo_controller.coffee"></script>
<script type="text/coffeescript">
    #@context = new nullmq.Context('ws://maeby.fobel.net:9000')
    @context = new nullmq.Context('ws://localhost:9000')
    width = d3.select("#chart").style("width")
    if width.substr(width.length - 2, width.length) == "px"
        width = eval(width.substr(0, width.length - 2))
    @placement_grid = new PlacementGrid("chart", 0.75 * width)

    @placement_controller = new PlacementController(@placement_grid, @context,
            'tcp://localhost:9003', 'tcp://localhost:9051')
    $("#id_clear_selection").click(() =>
        placement_grid.clear_selection()
    )
    placement_controller.initialize(() -> placement_controller.load_placement(true))

    $("#id_load_placement").click(() ->
        placement_controller.load_placement(true)
    )

    Mousetrap.bind('home', () -> placement_controller.home())
    Mousetrap.bind('end', () -> placement_controller.end())
    Mousetrap.bind('space', () -> placement_controller.next())
    Mousetrap.bind('n', () -> placement_controller.next())
    Mousetrap.bind('p', () -> placement_controller.previous())
    Mousetrap.bind('left', () -> placement_controller.previous())
    Mousetrap.bind('right', () -> placement_controller.next())
    Mousetrap.bind('a', () -> placement_controller.apply_swap_results())
    Mousetrap.bind('u', () -> placement_controller.undo_swaps())
    Mousetrap.bind('l', () -> placement_controller.load_placement(true));
    Mousetrap.bind('z', placement_grid.set_zoom_location);
</script>
</body>
</html>
