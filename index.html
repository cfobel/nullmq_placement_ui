<!DOCTYPE html PUBLIC "-/>
<html lang="en">
<head>
<title>NullMQ placement server example</title>
<link href="/dist/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<link href="/dist/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
<script type="text/javascript" src="/dist/lib/jquery-latest.js"></script>
<script type="text/javascript" src="/dist/lib/coffee-script.js"></script>
<script type="text/javascript" src="/dist/lib/d3.v2.js"></script>
<script type="text/javascript" src="/dist/lib/underscore-min.js"></script>
<script type="text/javascript" src="/dist/lib/mousetrap.min.js"></script>
<script type="text/javascript" src="/dist/lib/stomp.js"></script>
<script type="text/javascript" src="/dist/lib/nullmq.js"></script>
</head>
<body>
<div class="container">

<section id="placement_server_example">
  <div class="page-header">
    <h1>NullMQ placement server example</h1>
  </div>
  <div class="row">
    <p class="lead">Click the button below to load block positions from placement controller.</p>
    <fieldset>
        <button name="load_placement" id="id_load_placement">Load placement</button>
    </fieldset>
  </div>
</section>

<section id="placement">
  <div class="row">
    <div id="chart" class="span8 visible"></div>
    <div class="span4">
      <div class="row">
        <h3>Current block:</h3>
        <div id="placement_info_current" class="span4 visible" ></div>
      </div>
    </div>
    <div class="span4">
      <div class="row">
        <h3>Selected blocks:</h3>
        <fieldset>
            <button name="clear_selection" id="id_clear_selection">Clear selection</button>
        </fieldset>
        <div id="placement_info_selected" class="span4 visible" ></div>
      </div>
    </div>
    <div id="placement_info_template" class="invisible" >
    <!-- The contents of the tag are used as a template to format an info table
        for a block -->
        <table class="condensed-table table-bordered table-striped table-hover">
            <tbody>
            <tr><th>Coordinates</th><td class="block_coordinates">({{ x }}, {{ y }})</td></tr>
            <tr><th>Block id</th><td class="block_id">{{ block_id }}</td></tr>
            </tbody>
        </table>
    </div>
  </div>
</section>

<script type="text/coffeescript" src="/dist/grid.coffee"></script>
<script type="text/coffeescript" src="/dist/echo_controller.coffee"></script>
<script type="text/coffeescript">
    #@context = new nullmq.Context('ws://maeby.fobel.net:9000')
    @context = new nullmq.Context('ws://localhost:9000')
    width = d3.select("#chart").style("width")
    if width.substr(width.length - 2, width.length) == "px"
        width = eval(width.substr(0, width.length - 2))
    @placement_grid = new PlacementGrid("chart", 0.75 * width)

    @placement_controller = new PlacementController(@placement_grid, @context,
            'tcp://localhost:9003', 'tcp://localhost:9051')
    $("#id_clear_selection").click(() =>
        placement_grid.clear_selection()
    )
    @load_placement = () ->
        placement_controller.do_request({"command": "get_block_positions"}, (value) ->
            placement_grid.set_raw_block_positions(value.result)
            placement_controller.do_request({"command": "config"}, (response) ->
                    config = response.result
                    for a, i in config.area_ranges
                        a = new AreaRange(a[0], a[1], a[2], a[3])
                        placement_grid.highlight_area_range(a)
            )
            console.log("load_placement")
        )

    placement_controller.initialize(load_placement)

    $("#id_load_placement").click(() =>
        @load_placement()
    )

    Mousetrap.bind('space', () -> placement_controller.iterate_and_update(1))
    Mousetrap.bind('a', () -> placement_controller.apply_swap_results())
    Mousetrap.bind('l', load_placement);
    Mousetrap.bind('z', placement_grid.set_zoom_location);
</script>
</body>
</html>
